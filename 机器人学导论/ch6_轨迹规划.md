# ch6 轨迹规划
## 1. 简介
### 1. 规划
机器人根据自身任务特征，求得完成任务解决方案的过程，该过程是分层完成的

### 2. 路径/轨迹规划
#### 路径/轨迹规划任务定义
![20200416122157](https://raw.githubusercontent.com/s974534426/Img_for_notes/master/20200416122157.png)

根据作业要求，确定$^G_TT$，从而使机器人完成任务，并满足一定约束，比如时间，力等等

#### 路径规划
给定起始位形$q_s$和目标点位形$q_r$，在位形空间Q中找到一条满足一定约束条件的路径$\gamma(s)$

一般情况下，不会给出具体映射$\gamma$，只会给出一系列沿路径分布的点，这些点称为中间点或中间点

#### 中间点的设定问题

#### 轨迹规划
给定起始位形$q_s$和目标点位形$q_r$，以及一系列的中间点$q_k$，在位形空间中寻找一条满足一定约束的位形轨迹$q(t)$，使得



这个定义在位形空间中用关节变量定义的，但和在笛卡尔空间中使用位姿变量定义是等价的


前面得到的是离散的点，这里得到的是和时间相关的轨迹

#### 区别和联系
路径规划只是得到点，和时间没有关系，轨迹规划和时间有关

#### 实现
可以将轨迹生成问题分解为路径规划和轨迹规划两个子问题

#### 应用
移动机器人：通常是先用全局路径规划找到中间点，然后局部基于避碰策略进行轨迹生成

工业机器人：同样可以这样分解任务，但可能某些任务需求已经指定了中间点，此时只需要做轨迹规划就可以

## 2. 轨迹规划
![20200416132755](https://raw.githubusercontent.com/s974534426/Img_for_notes/master/20200416132755.png)
### 轨迹规划器的基本原理
输入为路径规划得到的点，优化目标，约束条件，返回与t有关的位姿或关节角度

### 优化目标选取
最短时间，最小能耗，灵活性最好等等

### 约束条件选取
位形可达，速度，加速度，无碰撞等等

### 规划空间的选择
笛卡尔空间：任务一般在笛卡尔空间给出，末端轨迹可控，直观，但需要求逆解得到关节轨迹

关节空间：末端轨迹不可预知，不直观，可能末端发生碰撞，跳动的问题等等

本质：操作空间和驱动空间不一致

### PTP vs CP
PTP：给定末端的起点和终点，同时给出一些中间经过点，规划任务是根据给定的路径点规划出这些点的平滑的运动轨迹

一般将路径点转化为关节空间表示，然后在**关节空间进行特定的光滑函数插值规划**

仅保证路径点的位姿精度，控制方法简单，运动速度块，多用于点焊、物料搬运、机器人空程运动等

CP：末端轨迹根据任务确定，安装一定采样间隔离散化，根据逆运动学计算变化到关节空间的若干路径点，然后在关节空间中寻找光滑函数来拟合这些离散点

在笛卡尔空间插值，得到间隔很小的离散路径点，然后同样在关节空间中按照PTP方式解决

机器人可以按照规定的速度、路线实现平稳正确的运动，保证位姿精度、运动平稳，但控制方式复杂

![20200416134738](https://raw.githubusercontent.com/s974534426/Img_for_notes/master/20200416134738.png)

两种方法其实都类似，都是转化到关节空间进行插值，CP由于使用的离散点更多，所以更加精确，耗时

### 轨迹生成方法分类
#### 关节空间规划法
#### 笛卡尔空间规划法
#### 人工示教再现法

### 注意
关节空间**归一化**处理，主要就是要起停一致，所有关节同时开始运动，同时停止运动

插补：精确拟合，需要经过所有路径点。可以再找两个中间点，使得要经过的点在这两个点的直线上，然后只需要从一个点直线运动到另一个，就可以经过这个点了。

近似，不一定经过所有路径点，只要在附近

## 3. 关节空间轨迹规划
![20200416135828](https://raw.githubusercontent.com/s974534426/Img_for_notes/master/20200416135828.png)

先进行路径规划，找到中间点，然后通过求逆解，求得每一个点的关节角度，然后进行拟合，得到参数化的曲线。注意要保证每个关节到达中间点和终点的时间都相同(归一化)

### 为什么要用参数化的曲线
点到点的运动，不一定是直线最短，反而可能是某一条曲线时间最短

![20200416141109](https://raw.githubusercontent.com/s974534426/Img_for_notes/master/20200416141109.png)

#### 1. 直线轨迹
$$\theta(t) = a_0+a_1(t-t_0), t\in [t_0, t_1]$$

给定两个点之后，就可以求解出参数$a_0$，$a_1$

缺点，端点处加速度无穷大，不够光滑

#### 2. 三次多项式(加加速度jerk为定值)
$$\theta(t) = a_0+a_1(t-t_0) + a_2(t-t_0)^2+a_3 (t-t_0)^3, t\in [t_0, t_1]$$

给定起始点，末端点的位置和速度，求解出四个参数

缺点，端点处加速度不够平稳，加速度图不是从0开始，可以改进为S型速度曲线规划

#### 3. 五次多项式
给定起始点、末端点的位置，速度，加速度，求解六个参数

优点，位置速度加速度都能平稳过渡，但阶次高，计算复杂

#### 4. 带抛物线过渡的直线轨迹
对直线轨迹进行改进，考虑了端点的加速度，在起停阶段加上抛物线进行过渡

给定起始终止点的位置速度

#### 5. S型速度规划曲线(七段式)
![20200416143444](https://raw.githubusercontent.com/s974534426/Img_for_notes/master/20200416143444.png)

#### 6. 其他
以上都是点到点的规划，两点之间，如果有多个中间点，则两两进行规划，保证中间点前后的速度，加速度不变

中间点期望速度确定：用户指定；采用启发式方式，自动设定，比如前后两段速度方向的点，设置为0，否则设置为平均速度；采用使加速度连续的方式

也可以用带中间过渡点的梯形速度曲线规划，中间点之间用线性函数相连，各中间点附近用抛物线拟合。如下图：关节位置并不是精确通过各个中间点，加速度越大，轨迹离中间点越近，也就是说，这里采用的是近似的方法来处理中间点。为了通过中间点，可以在中间点两端设置伪中间点。

![20200416144936](https://raw.githubusercontent.com/s974534426/Img_for_notes/master/20200416144936.png)

如果中间点需要拟合曲线通过，则采用经过点来描述。

## 4. 笛卡尔空间CP轨迹规划任务描述
一般对位置和姿态单独规划，也有方法同时插值规划

单独插值时，姿态通常由旋转矩阵表示，难于在SO(3)空间中插值，采用角坐标系、旋转向量，单位四元数的表示更为方便

![](https://raw.githubusercontent.com/s974534426/Img_for_notes/master/%E4%BD%8D%E7%BD%AE%E6%8F%92%E5%80%BC.png)

### 直线插补
(命名似乎就是按照末端的轨迹命名的)

得到总路程，根据插补时间和速度，得到单位插补时间的移动量，然后知道了需要插多少个点，得到插补点的坐标

### 圆弧插补

### 姿态球面线性插补SLERP
？？？好难，这啥
#### 四元数
高维的复数

#### SLERP
四元数两点之间线性插值有两种方法，Lerp和Slerp，Lerp得到的单位四元数并不是等距的，而Slerp在单位四元数空间下是等距

TODO，公式

### 定时插补和定距插补
轨迹插补即是轨迹离散的过程，通过离散点让机器人轨迹逼近要求轨迹

- 定时插补，隔时间$t_s$，仅为几毫秒，精度较低
- 定距插补，定距离，精度高，这里由于插补时间不定，实现复杂

### 笛卡尔路径中的几何问题
1. 不可达中间点
2. 奇异点附近的高关节速率
3. 多解

## 5. 任务分类
